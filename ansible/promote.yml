---
- name: Promote Secrets
  hosts: localhost
  gather_facts: no
  vars:
    vault_addr: "{{ lookup('env', 'VAULT_ADDR') }}"
    vault_role_id: "{{ lookup('env', 'VAULT_ROLE_ID') }}"
    vault_secret_id: "{{ lookup('env', 'VAULT_SECRET_ID') }}"

  tasks:
    - name: Validate Environment Variables
      fail:
        msg: "Environment variable '{{ item }}' is not set."
      when: lookup('env', item) == ""
      loop:
        - VAULT_ADDR
        - VAULT_ROLE_ID
        - VAULT_SECRET_ID

    - name: Ensure promotion_files variable is provided
      fail:
        msg: "Please provide 'promotion_files' variable (list of file paths)."
      when: promotion_files is not defined

    - block:
        - name: Authenticate to Vault
          community.hashi_vault.vault_login:
            url: "{{ vault_addr }}"
            auth_method: approle
            mount_point: actions
            role_id: "{{ vault_role_id }}"
            secret_id: "{{ vault_secret_id }}"
          register: vault_auth
      rescue:
        - name: Vault authentication failed - check Vault configuration and credentials
          fail:
            msg: >
              Vault authentication failed. Please verify that VAULT_ADDR
              ({{ vault_addr }}) is correct and reachable, and that
              VAULT_ROLE_ID and VAULT_SECRET_ID are set to valid, non-expired
              AppRole credentials.

    - name: Process Promotions
      include_tasks: process_promotion.yml
      loop: "{{ promotion_files }}"
      loop_control:
        loop_var: promotion_file
